AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Parameters:
  NotificationEmail:
    Type: String
  SiteUrl:
    Type: String
  NumberOfRuns:
    Type: Number
    MinValue: 1
    MaxValue: 10
    Default: 3
  KeyIdParameter:
    Type: String
  slackChannelParameter:
    Type: String
  kmsEncryptedHookUrlParameter:
    Type: String
Resources:
  CheckWebsitePeriodically:
    Type: AWS::Serverless::Function
    Properties:
      Handler: lambda/index.handler
      Runtime: nodejs12.x
      Policies:
        - CloudWatchPutMetricPolicy: {}
      Environment:
        Variables:
          URL: !Ref SiteUrl
          NUMBER_OF_AUDITS: !Ref NumberOfRuns
      MemorySize: 1024
      Timeout: 120
      Events:
        CheckWebsiteScheduledEvent:
          Type: Schedule
          Properties:
            Schedule: rate(1 minute)

  AlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Protocol: email
          Endpoint: !Ref NotificationEmail

  Alarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !Ref AlarmTopic
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref CheckWebsitePeriodically
      EvaluationPeriods: 1
      MetricName: First Meaningful Paint
      Namespace: Lighthouse
      Period: 60
      Statistic: Maximum
      Threshold: '9'

  cloudwatchalarmtoslack:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: cloudwatch-alarm-to-slack/index.handler
      Runtime: nodejs12.x
      CodeUri: .
      Description: >-
        An Amazon SNS trigger that sends CloudWatch alarm notifications to
        Slack.
      MemorySize: 128
      Timeout: 3
      Policies:
        - KMSDecryptPolicy:
            KeyId: !Ref KeyIdParameter
      Events:
        SNS1:
          Type: SNS
          Properties:
            Topic:
              Ref: AlarmTopic
      Environment:
        Variables:
          slackChannel: slackChannelParameter
          kmsEncryptedHookUrl: kmsEncryptedHookUrlParameter
